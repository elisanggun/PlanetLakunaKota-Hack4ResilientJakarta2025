<!DOCTYPE html>
<html lang="en" class="scroll-smooth">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Jakarta's Water Stories</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Playfair+Display:ital,wght@0,400..900;1,400..900&family=Inter:wght@300;400;500;600&display=swap');
        .story-font { font-family: 'Playfair Display', serif; }
        .ui-font { font-family: 'Inter', sans-serif; }
        #map { position: fixed; top: 0; left: 0; width: 100%; height: 100vh; z-index: 0; opacity: 0; transition: opacity 1.5s ease-in-out; }
        #map.visible { opacity: 1; }
        #story-container { position: relative; z-index: 10; }
        .chapter { min-height: 100vh; padding: 2rem; display: flex; align-items: center; }
        .story-card { max-width: 480px; backdrop-filter: blur(12px) saturate(150%); background: rgba(15, 23, 42, 0.85); border: 1px solid rgba(59, 130, 246, 0.15); transition: all 0.5s ease-in-out; opacity: 0.3; }
        .chapter.active .story-card { opacity: 1; transform: scale(1.05); box-shadow: 0 0 40px rgba(59, 130, 246, 0.3); }
        .story-card img { transition: opacity 0.5s ease-in-out; }
        #timeline-nav { opacity: 0; visibility: hidden; transition: opacity 0.8s ease, visibility 0.8s ease; }
        #timeline-nav.visible { opacity: 1; visibility: visible; }
        .timeline-point .timeline-dot { width: 0.75rem; height: 0.75rem; border-radius: 9999px; background-color: #4B5563; transition: all 0.3s; }
        .timeline-point .timeline-dot.active { transform: scale(1.8); background-color: #3B82F6; box-shadow: 0 0 15px rgba(59, 130, 246, 0.5); }
        .timeline-point .timeline-year { position: absolute; right: 100%; margin-right: 1rem; color: #9CA3AF; font-weight: 700; white-space: nowrap; opacity: 0; transition: all 0.3s; }
        .timeline-point:hover .timeline-year, .timeline-point.active .timeline-year { opacity: 1; transform: translateX(10px); }
        .timeline-point.active .timeline-year { color: #e0f2fe; }
        .fade-in-up { opacity: 0; transform: translateY(20px); animation: fadeInUp 1s ease-out forwards; }
        @keyframes fadeInUp { to { opacity: 1; transform: translateY(0); } }
        .scroll-arrow { animation: bounce 2s infinite; }
        @keyframes bounce { 0%, 20%, 50%, 80%, 100% { transform: translateY(0); } 40% { transform: translateY(-15px); } 60% { transform: translateY(-5px); } }

        /* Gaya untuk Legenda Melayang */
        #map-legend {
            position: fixed;
            bottom: 2rem;
            left: 2rem;
            z-index: 20;
            background: rgba(15, 23, 42, 0.85);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(59, 130, 246, 0.15);
            padding: 1rem;
            border-radius: 0.75rem;
            color: #e0f2fe;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.5s ease, visibility 0.5s ease;
            max-width: 300px;
        }
        #map-legend.visible {
            opacity: 1;
            visibility: visible;
        }
        .legend-item { display: flex; align-items: center; margin-bottom: 0.5rem; }
        .legend-item:last-child { margin-bottom: 0; }
        .legend-line { width: 20px; height: 4px; margin-right: 10px; border-radius: 2px; }
        .legend-point { width: 12px; height: 12px; margin-right: 10px; border-radius: 50%; box-sizing: border-box; }

        #hero {
            background-image: url('./code/assets/images/Cover.png');
            background-size: cover;
            background-position: center;
        }
    </style>
</head>
<body class="bg-slate-900 text-gray-200 ui-font">
    <div id="map"></div>
    <div id="map-legend"></div>

    <nav id="timeline-nav" class="fixed top-1/2 right-4 md:right-8 transform -translate-y-1/2 z-20 hidden lg:block">
        <div class="flex flex-col items-center space-y-4 relative">
            <div class="absolute top-0 left-1/2 -translate-x-1/2 w-0.5 h-full bg-slate-700"></div>
            <div id="timeline-progress" class="absolute top-0 left-1/2 -translate-x-1/2 w-0.5 bg-blue-500 transition-all duration-500" style="height: 0px;"></div>
            <a href="#chapter-1" data-chapter="1" class="timeline-point relative z-10 flex items-center group"><div class="timeline-dot"></div><span class="timeline-year">5th Century</span></a>
            <a href="#chapter-2" data-chapter="2" class="timeline-point relative z-10 flex items-center group"><div class="timeline-dot"></div><span class="timeline-year">1610</span></a>
            <a href="#chapter-3" data-chapter="3" class="timeline-point relative z-10 flex items-center group"><div class="timeline-dot"></div><span class="timeline-year">1620</span></a>
            <a href="#chapter-4" data-chapter="4" class="timeline-point relative z-10 flex items-center group"><div class="timeline-dot"></div><span class="timeline-year">1631</span></a>
            <a href="#chapter-5" data-chapter="5" class="timeline-point relative z-10 flex items-center group"><div class="timeline-dot"></div><span class="timeline-year">1714</span></a>
            <a href="#chapter-6" data-chapter="6" class="timeline-point relative z-10 flex items-center group"><div class="timeline-dot"></div><span class="timeline-year">1808</span></a>
            <a href="#chapter-7" data-chapter="7" class="timeline-point relative z-10 flex items-center group"><div class="timeline-dot"></div><span class="timeline-year">1893</span></a>
            <a href="#chapter-8" data-chapter="8" class="timeline-point relative z-10 flex items-center group"><div class="timeline-dot"></div><span class="timeline-year">1909</span></a>
            <a href="#chapter-9" data-chapter="9" class="timeline-point relative z-10 flex items-center group"><div class="timeline-dot"></div><span class="timeline-year">1918</span></a>
            <a href="#chapter-10" data-chapter="10" class="timeline-point relative z-10 flex items-center group"><div class="timeline-dot"></div><span class="timeline-year">1919</span></a>
            <a href="#chapter-11" data-chapter="11" class="timeline-point relative z-10 flex items-center group"><div class="timeline-dot"></div><span class="timeline-year">1932</span></a>
            <a href="#chapter-12" data-chapter="12" class="timeline-point relative z-10 flex items-center group"><div class="timeline-dot"></div><span class="timeline-year">1949</span></a>
            <a href="#chapter-13" data-chapter="13" class="timeline-point relative z-10 flex items-center group"><div class="timeline-dot"></div><span class="timeline-year">1956</span></a>
            <a href="#chapter-14" data-chapter="14" class="timeline-point relative z-10 flex items-center group"><div class="timeline-dot"></div><span class="timeline-year">1960</span></a>
            <a href="#chapter-15" data-chapter="15" class="timeline-point relative z-10 flex items-center group"><div class="timeline-dot"></div><span class="timeline-year">2024</span></a>
        </div>
    </nav>
    <div id="story-container">
        <section id="hero" class="h-screen flex flex-col justify-center items-center text-center p-4">
            <h1 class="story-font text-blue-500 text-6xl md:text-8xl font-bold fade-in-up">Jakarta's Water Stories</h1>
            <p class="ui-font text-blue-500 md:text-xl mt-4 max-w-2xl fade-in-up" style="animation-delay: 0.3s;">A journey to find the "Way Home"</p>
            <a href="#chapter-1" class="mt-8 bg-white text-blue-700 font-bold py-3 px-8 rounded-full text-lg transition-transform transform hover:scale-105 fade-in-up" style="animation-delay: 0.6s;">Begin the Journey</a>
            <div class="absolute bottom-8 text-white fade-in-up" style="animation-delay: 1s;"><svg class="w-6 h-6 scroll-arrow" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 14l-7 7m0 0l-7-7m7 7V3"></path></svg></div>
        </section>

        <section id="chapter-1" class="chapter justify-start" data-geojson-layer="tugu" data-legend-text="Discovery Site of Tugu Inscription">
            <div class="story-card rounded-2xl shadow-2xl overflow-hidden">
                 <img src="./code/assets/images/prasasti_tugu_500.png" alt="Prasasti Tugu" class="w-full h-64 object-cover">
                <div class="p-8 md:p-10">
                    <p class="font-bold text-lg text-gray-300 mb-4">5th Century AD</p>
                    <h2 class="story-font text-3xl md:text-4xl text-blue-300 mb-2">The origin of the Delta</h2>
                    <p class="text-base leading-relaxed">In the journey of tracing the origins of Jakarta, one cannot be separated from how nature is interconnected and engages in gentle dialogue. The forces of wind and river played a role in shaping space; through layers of sediment that intertwined, they welcomed life. River deposits that accumulated formed natural levees and hills, while the interplay of accretion and abrasion created the contours of a delta’s boundaries. This cycle kept repeating—at times they died, only to come alive again. To sustain life, Purnawarman, the 5th-century king of Tarumanegara, carried out river excavations to secure food supplies and provide additional water catchment areas in response to the abundant flows.</p>
                </div>
            </div>
        </section>

        <section id="chapter-2" class="chapter justify-end" data-geojson-layer="canal1619" data-legend-text="Batavia Canal 1619">
            <div class="story-card rounded-2xl shadow-2xl overflow-hidden">
                 <img src="./code/assets/images/batavia_1683.jpg" alt="batavia_1683" class="w-full h-64 object-cover">
                <div class="p-8 md:p-10">
                    <p class="font-bold text-lg text-gray-300 mb-4">1610</p>
                    <h2 class="story-font text-3xl md:text-4xl text-blue-300 mb-2">A Distant Guest Wishing to Settle</h2>
                    <p class="text-base leading-relaxed">After centuries had passed, the Delta grew ever more prosperous as it became a center of global trade routes, drawing more and more people to dwell there. Among them was a Western trading company, known as the VOC, which stopped by as a guest. Soon after, it invited its close kin from the Netherlands. Yet, they carried a hidden plan—for they too desired to claim power.</p>
                </div>
            </div>
        </section>

        <section id="chapter-3" class="chapter justify-end" data-geojson-layer="canal1650" data-legend-text="Canal Development 1650">
            <div class="story-card rounded-2xl shadow-2xl overflow-hidden">
                 <img src="./code/assets/images/batavia_1682.jpeg" alt="Batavia 1682" class="w-full h-64 object-cover">
                <div class="p-8 md:p-10">
                    <p class="font-bold text-lg text-gray-300 mb-4">1620</p>
                    <h2 class="story-font text-3xl md:text-4xl text-blue-300 mb-2">Straightening What Is Crooked, Yet in Pain</h2>
                    <p class="text-base leading-relaxed">Though it grew ever more crowded, becoming a hub where people gathered and traded, nature never ceased its dialogue, echoing without end. The guest who once only stayed the night now built a dwelling to settle. The river, once meandering, was now straightened, forming canals and new networks to boost the economy and provide safety from the floods that struck.</p>
                </div>
            </div>
        </section>

        <section id="chapter-4" class="chapter justify-start" data-geojson-layer="canal1700" data-legend-text="Molenvliet Canal">
            <div class="story-card rounded-2xl shadow-2xl overflow-hidden">
                 <img src="./code/assets/images/canal/molenvliet_1870.jpg" alt="molenvliet_1870" class="w-full h-64 object-cover">
                <div class="p-8 md:p-10">
                    <p class="font-bold text-lg text-gray-300 mb-4">1631</p>
                    <h2 class="story-font text-3xl md:text-4xl text-blue-300 mb-2">Molenvliet, an Intervention from the east</h2>
                    <p class="text-base leading-relaxed">During the period of territorial expansion, a new canal in the southern part called Molenvliet was built by the Chinese captain Phoa Beng Gan, intended for transportation and the economic development of the area. At its peak, Molenvliet thrived and became a pleasant public space.</p>
                </div>
            </div>
        </section>

        <section id="chapter-5" class="chapter justify-start" data-lat="-6.5975" data-lon="106.7995" data-zoom="11">
            <div class="story-card rounded-2xl shadow-2xl overflow-hidden">
                 <img src="./code/assets/images/perkebunan_bogor_1871.jpg" alt="Perkebunan di Bogor" class="w-full h-64 object-cover">
                <div class="p-8 md:p-10">
                    <p class="font-bold text-lg text-gray-300 mb-4">1714</p>
                    <h2 class="story-font text-3xl md:text-4xl text-blue-300 mb-2">When the Peak Was Stripped</h2>
                    <p class="text-base leading-relaxed">For the sake of industrial expansion, nature’s breath was sacrificed. The slopes of Puncak Bogor were stripped bare, until the land released water without pause. Floods spread everywhere, carrying stories of sorrow from the mountain to the estuary</p>
                </div>
            </div>
        </section>


        <section id="chapter-6" class="chapter justify-end" data-geojson-layer="canal1797,weltevreden" data-legend-text="Canal 1797|Weltevreden Area">
            <div class="story-card rounded-2xl shadow-2xl overflow-hidden">
                 <img src="./code/assets/images/canal/weltevreden_1895.jpg" alt="Weltevreden" class="w-full h-64 object-cover">
                <div class="p-8 md:p-10">
                    <p class="font-bold text-lg text-gray-300 mb-4">1808</p>
                    <h2 class="story-font text-3xl md:text-4xl text-blue-300 mb-2">From Canals to Land</h2>
                    <p class="text-base leading-relaxed">As a result of disease outbreaks, the government center was moved from Batavia, the old settlement, farther inland to the Weltevreden area. Small canals used for transport and irrigation were filled in to reduce sources of disease, transforming the city from a canal-based settlement to one oriented around land-based transportation.</p>
                </div>
            </div>
        </section>

        <section id="chapter-7" class="chapter justify-start" data-geojson-layer="flood1893" data-legend-text="Flood Area 1893">
            <div class="story-card rounded-2xl shadow-2xl overflow-hidden">
                 <img src="./code/assets/images/flood/batavia_flood_1898.jpg" alt="Banjir Batavia 1898" class="w-full h-64 object-cover">
                <div class="p-8 md:p-10">
                    <p class="font-bold text-lg text-gray-300 mb-4">1893</p>
                    <h2 class="story-font text-3xl md:text-4xl text-blue-300 mb-2">The Continuing Floods</h2>
                    <p class="text-base leading-relaxed">1893 marked the first major flood to hit Batavia in the 19th century. Flooding continued repeatedly in 1895, 1899, 1904, and 1909. Cholera outbreaks also emerged, claiming many lives. The government at the time began reconsidering future actions, which led to the proposal of the Western Flood Canal initiative by Hendrik Van Breen.</p>
                </div>
            </div>
        </section>

        <section id="chapter-8" class="chapter justify-end" data-geojson-layer="flood1909" data-legend-text="Flood Area 1909">
            <div class="story-card rounded-2xl shadow-2xl overflow-hidden">
                 <img src="./code/assets/images/flood/batavia_flood_1915.jpg" alt="Banjir Batavia 1915" class="w-full h-64 object-cover">
                <div class="p-8 md:p-10">
                    <p class="font-bold text-lg text-gray-300 mb-4">1909</p>
                    <h2 class="story-font text-3xl md:text-4xl text-blue-300 mb-2">The Longtime Residents Growing More Oppressed</h2>
                    <p class="text-base leading-relaxed">Flooding from the overflowing Ciliwung and Krukut rivers inundated the Waterlooplein area, now known as Lapangan Banteng, turning it into a lake-like expanse. The water didn’t stop there, spreading to surrounding Bumiputra settlements—Kampung Kepu, Nyonya Wetan, Bendungan, and Kemayoran—leaving them heavily affected. Unfortunately, these Bumiputra neighborhoods received little special attention.</p>
                </div>
            </div>
        </section>

        <section id="chapter-9" class="chapter justify-start" data-geojson-layer="canal1937" data-legend-text="Masterplan Canal 1937">
            <div class="story-card rounded-2xl shadow-2xl overflow-hidden">
                 <img src="./code/assets/images/masterplan_1919.png" alt="masterplan 1919" class="w-full h-64 object-cover">
                <div class="p-8 md:p-10">
                    <p class="font-bold text-lg text-gray-300 mb-4">1918</p>
                    <h2 class="story-font text-3xl md:text-4xl text-blue-300 mb-2">The Idea of the Western Flood Canal</h2>
                    <p class="text-base leading-relaxed">The tales of the river’s overflow led Van Breen to conceive real solutions, as the rivers in the western part were manipulated and engineered. The construction of the western flood canal stretched from Manggarai westward through Karet, then turned toward the sea, ending at Muara Angke in North Jakarta.</p>
                </div>
            </div>
        </section>

           <section id="chapter-10" class="chapter justify-start" data-geojson-layer="flood1919" data-legend-text="Flood Area 1919">
            <div class="story-card rounded-2xl shadow-2xl overflow-hidden">
                 <img src="./code/assets/images/flood/batavia_flood_1920.jpg" alt="Banjir Batavia 1920" class="w-full h-64 object-cover">
                <div class="p-8 md:p-10">
                    <p class="font-bold text-lg text-gray-300 mb-4">1919</p>
                    <h2 class="story-font text-3xl md:text-4xl text-blue-300 mb-2">When the Water Raged</h2>
                    <p class="text-base leading-relaxed">Something broke in Grogol! Flooding nearly the entire city, it became the greatest disaster compared to previous years. The swift current caused Weltevreden to be submerged. The sluice gates were opened from two directions—Batavia in the north and Weltevreden in the south—sending the torrent rushing toward Kali Lio. Unable to contain it, the water spilled over into the surrounding Bumiputra areas, and the villages once again became victims. The areas around Molenvliet, which had once been scattered, grew even wetter due to the construction of the Harmony Bridge, which narrowed the flow of the river.</p>
                </div>
            </div>
        </section>

        <section id="chapter-11" class="chapter justify-end" data-geojson-layer="flood1932,flood1932b" data-legend-text="Flood Area 1932|Impacted Zone">
             <div class="story-card rounded-2xl shadow-2xl overflow-hidden">
                 <img src="./code/assets/images/flood/batavia_flood_1935.jpg" alt="Banjir Batavia 1935" class="w-full h-64 object-cover">
                <div class="p-8 md:p-10">
                    <p class="font-bold text-lg text-gray-300 mb-4">1932</p>
                    <h2 class="story-font text-3xl md:text-4xl text-blue-300 mb-2">A Flow That Spreads Further</h2>
                    <p class="text-base leading-relaxed">The solution of straightening the western water channels had not proven optimal, leading to increasingly prolonged problems. The flooding spread even more when the Citarum and Kedawung dams also broke.</p>
                </div>
             </div>
        </section>

        <section id="chapter-12" class="chapter justify-end" data-lat="-6.19" data-lon="106.83" data-zoom="13">
             <div class="story-card rounded-2xl shadow-2xl overflow-hidden">
                 <img src="./code/assets/images/masterplan_1949.png" alt="Masterplan 1949" class="w-full h-64 object-cover">
                <div class="p-8 md:p-10">
                    <p class="font-bold text-lg text-gray-300 mb-4">1949</p>
                    <h2 class="story-font text-3xl md:text-4xl text-blue-300 mb-2">Two Blueprint Sketches Take Shape</h2>
                    <p class="text-base leading-relaxed">Hope was outlined in the form of a master plan for flood management from 1919 to 1949, drafted by Van Breen and later supplemented with Blommestein’s ideas in 1949. Line by line, the plans reinforced a technocratic vision for the future. These two major planning documents proposed extensive flood control projects: the construction of the eastern canal, pumping systems, additional sluice gates, retention reservoirs, polders, and a seawall along Jakarta Bay.</p>
                </div>
             </div>
        </section>

        <section id="chapter-13" class="chapter justify-start" data-geojson-layer="intervensi" data-legend-text="Citizen Intervention">
            <div class="story-card rounded-2xl shadow-2xl p-8 md:p-10">
                <p class="font-bold text-lg text-gray-300 mb-4">1956</p>
                <h2 class="story-font text-3xl md:text-4xl text-blue-300 mb-2">Voices of Hope from Home</h2>
                <p class="text-base leading-relaxed">Local voices began to surface. People helped one another, working together to spark the first glimmers of hope toward finding a way home. At the time, the government had no funds and was preoccupied with the affairs of a still-new administration. To adapt to the situation, local residents took flood control into their own hands, acting independently.</p>
            </div>
        </section>

        <section id="chapter-14" class="chapter justify-end" data-geojson-layer="canal1959,waduk1960" data-legend-text="Canal 1959|Reservoir 1960">
            <div class="story-card rounded-2xl shadow-2xl overflow-hidden">
                <img src="./code/assets/images/waduk_melati.jpg" alt="waduk_melati" class="w-full h-64 object-cover">
                <div class="p-8 md:p-10">
                    <p class="font-bold text-lg text-gray-300 mb-4">1960</p>
                    <h2 class="story-font text-3xl md:text-4xl text-blue-300 mb-2">Finding The Way Home</h2>
                    <p class="text-base leading-relaxed">From the two old blueprints that had been laid out, the city’s direction was set. Two major projects were launched: upstream projects focused on river normalization and the construction of reservoirs, while downstream projects involved dredging and arranging green river corridors. Some of these projects forced the displacement of livelihoods, and the search for a true way home increasingly became neglected.</p>
                </div>
            </div>
        </section>

        <section id="chapter-15" class="chapter justify-end" data-geojson-layer="canal2024,flood2024" data-legend-text="Canal 2024|Flood Area 2024">
            <div class="story-card rounded-2xl shadow-2xl overflow-hidden">
                <img src="./code/assets/images/jakarta_flood_now.jpg" alt="Banjir Jakarta Masa kini" class="w-full h-64 object-cover">
                <div class="p-8 md:p-10">
                    <p class="font-bold text-lg text-gray-300 mb-4">2024</p>
                    <h2 class="story-font text-3xl md:text-4xl text-blue-300 mb-2">Toward Homecoming</h2>
                    <p class="text-base leading-relaxed">Let us reflect more deeply on today’s conditions—how stakeholders perceive the issue of flooding today. Grand plans for flood control have indeed been laid out, but are they truly in line with the existing context? Let us think again, revisiting the inherent character of the delta: should we truly seek to control it all, or shall we begin to make peace with it?</p>
                </div>
            </div>
        </section>

        <section id="epilog" class="chapter min-h-screen justify-center items-center">
            <div class="text-center max-w-3xl mx-auto">
                <h2 class="story-font text-4xl md:text-5xl text-white mb-6">EPILOGUE: Towards Home, Though Times Differ</h2>
                <p class="text-lg text-slate-300 leading-relaxed mb-8">This journey is about the memory of the delta that became Jakarta. Its story is not yet over. ‘The Way Home’ is not about returning to the past, but about finding new ways to live in harmony with water in the future. The next chapter lies in our hands</p>
                <a href="code/dashboard.html" class="bg-blue-600 hover:bg-blue-500 text-white font-bold py-4 px-10 rounded-lg text-xl transition-transform transform hover:scale-105">Explore Data & Write a New Chapter</a>
            </div>
        </section>
    </div>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const map = L.map('map', { scrollWheelZoom: false, zoomControl: false }).setView([-6.2088, 106.8456], 11);
            L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', { attribution: '&copy; CARTO' }).addTo(map);

            const mapElement = document.getElementById('map');
            const legendElement = document.getElementById('map-legend');
            const timelineNav = document.getElementById('timeline-nav');
            const heroSection = document.getElementById('hero');

            let activeGeoJsonLayers = [];
            const geojsonLayers = {};

            async function preloadGeoJsonLayers() {
                const layerConfig = {
                    'tugu': './code/assets/data/points/prasasti_tugu.geojson',
                    'canal1619': './code/assets/data/canal/1619_canal.geojson',
                    'canal1650': './code/assets/data/canal/1650_canal.geojson',
                    'canal1700': './code/assets/data/canal/1700_canal.geojson',
                    'canal1797': './code/assets/data/canal/1797_canal.geojson',
                    'canal1937': './code/assets/data/canal/1937_canal.geojson',
                    'canal1959': './code/assets/data/canal/1959_canals.geojson',
                    'canal2024': './code/assets/data/canal/2024_canals.geojson',
                    'flood1893': './code/assets/data/flood/1893_flood.geojson',
                    'flood1909': './code/assets/data/flood/1909_flood.geojson',
                    'flood1919': './code/assets/data/flood/1919_flood.geojson',
                    'flood1932': './code/assets/data/flood/1932_flood.geojson',
                    'flood1932b': './code/assets/data/flood/1932_flood_buff.geojson',
                    'flood2024': './code/assets/data/flood/2024_flood.geojson',
                    'waduk1960': './code/assets/data/hidrology/1960_waduk.geojson',
                    'intervensi': './code/assets/data/1952_intervensi_warga.geojson',
                    'weltevreden': './code/assets/data/adm/weltevreden.geojson'
                };

                for (const key in layerConfig) {
                    try {
                        const response = await fetch(layerConfig[key]);
                        if (!response.ok) throw new Error(`Gagal memuat ${layerConfig[key]}`);
                        const data = await response.json();
                        const color = key.includes('flood') ? "#EF4444" : "#3B82F6";

                        if (data.features[0]?.geometry.type === 'Point') {
                             geojsonLayers[key] = L.geoJSON(data, {
                                pointToLayer: function (feature, latlng) {
                                    return L.circleMarker(latlng, {
                                        radius: 8,
                                        fillColor: color,
                                        color: "#FFF",
                                        weight: 2,
                                        opacity: 1,
                                        fillOpacity: 0.8
                                    });
                                }
                            });
                        } else {
                            geojsonLayers[key] = L.geoJSON(data, {
                                style: { color: color, weight: 3, opacity: 0.8 }
                            });
                        }
                    } catch (error) {
                        console.error(error);
                    }
                }
            }

            function updateMapState(chapter) {
                activeGeoJsonLayers.forEach(layer => map.removeLayer(layer));
                activeGeoJsonLayers = [];

                const geojsonKeys = chapter.dataset.geojsonLayer ? chapter.dataset.geojsonLayer.split(',').map(k => k.trim()) : [];

                if (geojsonKeys.length > 0) {
                    let combinedBounds = L.latLngBounds([]);
                    geojsonKeys.forEach(key => {
                        if (geojsonLayers[key]) {
                            const layer = geojsonLayers[key];
                            map.addLayer(layer);
                            activeGeoJsonLayers.push(layer);
                            combinedBounds.extend(layer.getBounds());
                        }
                    });
                    if(combinedBounds.isValid()) {
                        map.flyToBounds(combinedBounds, { padding: [50, 50], duration: 1.5 });
                    }
                } else {
                    const lat = parseFloat(chapter.dataset.lat);
                    const lon = parseFloat(chapter.dataset.lon);
                    const zoom = parseInt(chapter.dataset.zoom);
                    if (!isNaN(lat) && !isNaN(lon) && !isNaN(zoom)) {
                        map.flyTo([lat, lon], zoom, { duration: 2, easeLinearity: 0.25 });
                    }
                }

                const legendTexts = chapter.dataset.legendText ? chapter.dataset.legendText.split('|') : [];
                if (legendTexts.length > 0 && geojsonKeys.length > 0) {
                    let legendHtml = '';
                    geojsonKeys.forEach((key, index) => {
                         if (geojsonLayers[key]) {
                            const layer = geojsonLayers[key];
                            const text = legendTexts[index] || '';
                            let symbolHtml = '';
                             if (layer.getLayers && layer.getLayers()[0] instanceof L.CircleMarker) {
                                const pointStyle = layer.getLayers()[0].options;
                                symbolHtml = `<div class='legend-point' style='background-color: ${pointStyle.fillColor}; border: ${pointStyle.weight}px solid ${pointStyle.color};'></div>`;
                            } else {
                                const lineStyle = layer.options.style || geojsonLayers[key].getLayers()[0].options.style;
                                symbolHtml = `<div class='legend-line' style='background-color: ${lineStyle.color};'></div>`;
                            }
                            legendHtml += `<div class='legend-item'>${symbolHtml}<span>${text}</span></div>`;
                         }
                    });
                    legendElement.innerHTML = legendHtml;
                    legendElement.classList.add('visible');
                } else {
                    legendElement.classList.remove('visible');
                }
            }

            const storyObserver = new IntersectionObserver(entries => {
                entries.forEach(entry => {
                    const chapter = entry.target;
                    if (entry.isIntersecting && entry.intersectionRatio >= 0.5) {
                        document.querySelectorAll('.chapter').forEach(c => c.classList.remove('active'));
                        chapter.classList.add('active');
                        updateMapState(chapter);
                        const chapterNum = parseInt(chapter.id.replace('chapter-', ''));
                        updateTimeline(chapterNum);
                    }
                });
            }, { threshold: 0.5 });

            const heroObserver = new IntersectionObserver(entries => {
                entries.forEach(entry => {
                    if (entry.isIntersecting) {
                        mapElement.classList.remove('visible');
                        timelineNav.classList.remove('visible');
                        legendElement.classList.remove('visible');
                        activeGeoJsonLayers.forEach(layer => map.removeLayer(layer));
                        activeGeoJsonLayers = [];
                    } else {
                        mapElement.classList.add('visible');
                        timelineNav.classList.add('visible');
                    }
                });
            }, { threshold: 0.1 });

            async function initialize() {
                await preloadGeoJsonLayers();
                heroObserver.observe(heroSection);
                document.querySelectorAll('.chapter').forEach(chapter => {
                    if(chapter.id.startsWith('chapter-')) storyObserver.observe(chapter);
                });
            }

            initialize();

            function updateTimeline(chapterNum) {
                const timelinePoints = document.querySelectorAll('.timeline-point');
                if (isNaN(chapterNum) || !timelinePoints.length) return;
                timelinePoints.forEach((point, index) => {
                    const isActive = (index + 1) === chapterNum;
                    point.classList.toggle('active', isActive);
                    point.querySelector('.timeline-dot').classList.toggle('active', isActive);
                });
                const progress = document.getElementById('timeline-progress');
                if (chapterNum > 0 && chapterNum <= timelinePoints.length) {
                    const firstPoint = timelinePoints[0];
                    const currentPoint = timelinePoints[chapterNum - 1];
                    progress.style.height = `${currentPoint.offsetTop - firstPoint.offsetTop}px`;
                }
            }

            document.querySelectorAll('.timeline-point').forEach(point => {
                point.addEventListener('click', e => {
                    e.preventDefault();
                    document.querySelector(point.getAttribute('href')).scrollIntoView({ behavior: 'smooth' });
                });
            });
        });
    </script>
</body>
</html>
