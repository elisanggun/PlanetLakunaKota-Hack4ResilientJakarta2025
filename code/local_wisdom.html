<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Local Wisdom Map - Shape of Jakarta</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Playfair+Display:ital,wght@0,400..900;1,400..900&family=Inter:wght@300;400;500;600&display=swap');
        .story-font { font-family: 'Playfair Display', serif; }
        .ui-font { font-family: 'Inter', sans-serif; }
        #map { height: 100vh; width: 100vw; position: absolute; top: 0; left: 0; z-index: 10; }
        .header-overlay { position: absolute; top: 0; left: 0; right: 0; z-index: 20; pointer-events: none; }
        .header-overlay > * { pointer-events: auto; }
        #gallery-container { position: absolute; bottom: 0; left: 0; right: 0; z-index: 30; }
        #gallery-panel { background: rgba(15, 23, 42, 0.9); backdrop-filter: blur(10px); border-top: 1px solid rgba(59, 130, 246, 0.2); overflow-x: auto; overflow-y: hidden; white-space: nowrap; transition: transform 0.4s ease-in-out; transform: translateY(0); }
        #gallery-panel.hidden { transform: translateY(100%); }
        #gallery-toggle { position: absolute; bottom: 100%; right: 1rem; }
        .gallery-card { transition: background-color 0.3s ease, border-top 0.3s ease; border-right: 1px solid rgba(59, 130, 246, 0.15); display: inline-block; width: 320px; vertical-align: top; white-space: normal; }
        .gallery-card:hover { background-color: rgba(30, 41, 59, 0.7); }
        .gallery-card.active { background-color: rgba(37, 99, 235, 0.4); border-top: 4px solid #3B82F6; }
        .custom-marker-icon { background-color: rgba(52, 211, 153, 0.8); border: 2px solid #e0f2fe; border-radius: 50%; width: 20px; height: 20px; box-shadow: 0 0 15px rgba(52, 211, 153, 0.7); transition: all 0.3s ease; }
        .custom-marker-icon:hover, .custom-marker-icon.active { transform: scale(1.8); background-color: rgba(110, 231, 183, 1); }
        .modal { display: none; }
        .modal.open { display: flex; }
        .modal-content { animation: fadeInScale 0.4s ease-out; }
        @keyframes fadeInScale { from { opacity: 0; transform: scale(0.9); } to { opacity: 1; transform: scale(1); } }
    </style>
</head>
<body class="bg-slate-900 text-gray-200 ui-font overflow-hidden">

    <div id="map"></div>

    <header class="header-overlay p-6 text-center bg-gradient-to-b from-slate-900 via-slate-900/80 to-transparent">
        <h1 class="story-font text-white text-4xl md:text-5xl font-bold">Peta Kearifan Lokal Jakarta</h1>
        <p class="ui-font text-slate-300 text-md md:text-lg mt-2">Jelajahi kearifan lokal di pesisir Jakarta</p>
        <a href="dashboard.html" class="mt-4 inline-block text-blue-400 hover:text-blue-300 transition text-sm">&larr; Kembali ke Dashboard Utama</a>
    </header>

    <div id="gallery-container">
        <button id="gallery-toggle" class="bg-gradient-to-t from-blue-600 to-blue-700 hover:from-blue-500 hover:to-blue-600 text-white w-14 h-12 rounded-t-lg flex items-center justify-center z-10 shadow-lg transition-all duration-300 transform hover:-translate-y-1">
            <div id="toggle-icon-wrapper" class="transition-transform duration-300">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M19 9l-7 7-7-7" /></svg>
            </div>
        </button>
        <div id="gallery-panel" class="w-full h-auto p-2">
            <div id="gallery-list" class="flex">
                <!-- Kartu galeri akan dibuat secara dinamis dari GeoJSON -->
            </div>
        </div>
    </div>

    <div id="imageModal" class="modal fixed inset-0 bg-black bg-opacity-80 z-50 items-center justify-center p-4">
        <div class="modal-content bg-slate-800 rounded-lg shadow-2xl max-w-4xl w-full max-h-full overflow-auto flex flex-col md:flex-row">
            <img id="modalImage" src="" alt="Gambar Detail" class="w-full md:w-2/3 h-auto object-contain bg-black">
            <div class="p-6 flex flex-col">
                <h3 id="modalTitle" class="story-font text-3xl text-green-300 mb-2"></h3>
                <p id="modalDescription" class="text-gray-300 leading-relaxed flex-grow"></p>
                <button onclick="closeModal()" class="mt-4 self-start md:self-end bg-blue-600 hover:bg-blue-500 text-white font-bold py-2 px-6 rounded-lg transition">Tutup</button>
            </div>
        </div>
        <button onclick="closeModal()" class="absolute top-4 right-4 text-white text-4xl">&times;</button>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <script>
        let map;
        const markers = {};
        const wisdomData = {};
        let activeGeoJSONLayer = null; // Layer untuk GeoJSON yang sedang aktif

        function openModal(imageSrc, title, description) {
            document.getElementById('modalImage').src = imageSrc;
            document.getElementById('modalTitle').textContent = title;
            document.getElementById('modalDescription').textContent = description;
            document.getElementById('imageModal').classList.add('open');
        }

        function closeModal() {
            document.getElementById('imageModal').classList.remove('open');
        }

        function highlightActive(id) {
            document.querySelectorAll('.gallery-card').forEach(c => c.classList.remove('active'));
            const card = document.getElementById(`card-${id}`);
            if (card) card.classList.add('active');

            Object.values(markers).forEach(m => m.getElement().classList.remove('active'));
            if (markers[id]) markers[id].getElement().classList.add('active');
        }

        function displayGeoJSON(data) {
            if (activeGeoJSONLayer) {
                map.removeLayer(activeGeoJSONLayer);
            }
            activeGeoJSONLayer = L.geoJSON(data, { style: { color: "#f59e0b", weight: 3, opacity: 0.8 } }).addTo(map);
            map.fitBounds(activeGeoJSONLayer.getBounds());
        }

        document.addEventListener('DOMContentLoaded', () => {
            map = L.map('map').setView([-6.12, 106.85], 12);
            L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
                attribution: '&copy; CARTO',
                maxZoom: 19
            }).addTo(map);

            const modal = document.getElementById('imageModal');
            modal.addEventListener('click', (event) => {
                if (event.target === modal) closeModal();
            });

            const geojsonFiles = [
                'cilincing_wisdom.geojson',
                'penjaringan_wisdom.geojson',
                'priok_wisdom.geojson'
            ];

            const galleryList = document.getElementById('gallery-list');

            const processGeoJSON = (url) => {
                return fetch(url)
                    .then(response => {
                        if (!response.ok) throw new Error(`Gagal memuat: ${url}`);
                        return response.json();
                    })
                    .then(data => {
                        const feature = data.features[0];
                        const props = feature.properties;
                        const id = url.split('/').pop().replace('.geojson', '');

                        let coords;
                        if (feature.geometry.type === 'Point') {
                            coords = [feature.geometry.coordinates[1], feature.geometry.coordinates[0]];
                        } else {
                            const firstPoint = feature.geometry.coordinates[0];
                            coords = Array.isArray(firstPoint[0]) ? [firstPoint[0][1], firstPoint[0][0]] : [firstPoint[1], firstPoint[0]];
                        }

                        // FIX: Menghapus './' dari path gambar
                        const imageExtension = id === 'priok_wisdom' ? 'jpeg' : 'jpg';
                        wisdomData[id] = {
                            id: id,
                            title: props.name || 'Tanpa Judul',
                            description: props.description || 'Tidak ada deskripsi.',
                            image: `assets/images/wisdom/${id}.${imageExtension}`,
                            lat: coords[0],
                            lng: coords[1],
                            geojsonData: data
                        };

                        const point = wisdomData[id];

                        const card = document.createElement('div');
                        card.className = 'gallery-card p-4 cursor-pointer';
                        card.id = `card-${id}`;
                        card.innerHTML = `
                            <img src="${point.image}" alt="${point.title}" class="w-full h-40 object-cover rounded-md mb-3" onerror="this.onerror=null;this.src='https://placehold.co/300x200/1e293b/94a3b8?text=Image+Not+Found'">
                            <h3 class="font-bold text-lg text-green-300">${point.title}</h3>
                            <p class="text-sm text-slate-400">${point.description.substring(0, 100)}...</p>
                        `;
                        galleryList.appendChild(card);

                        const customIcon = L.divIcon({ className: 'custom-marker-icon', iconSize: [20, 20] });
                        const marker = L.marker([point.lat, point.lng], { icon: customIcon }).addTo(map);
                        markers[id] = marker;

                        const handleClick = () => {
                            openModal(point.image, point.title, point.description);
                            displayGeoJSON(point.geojsonData);
                            highlightActive(id);
                        };

                        card.addEventListener('click', () => {
                            handleClick();
                            map.flyTo([point.lat, point.lng], 14);
                        });
                        marker.on('click', () => {
                            handleClick();
                            card.scrollIntoView({ behavior: 'smooth', inline: 'center' });
                        });
                    });
            };

            // FIX: Menghapus './' dari path fetch
            Promise.all(geojsonFiles.map(file => processGeoJSON(`assets/data/wisdom/${file}`)))
                .catch(error => console.error("Terjadi kesalahan saat memuat data kearifan lokal:", error));

            const galleryPanel = document.getElementById('gallery-panel');
            const galleryToggle = document.getElementById('gallery-toggle');
            const toggleIconWrapper = document.getElementById('toggle-icon-wrapper');
            galleryToggle.addEventListener('click', () => {
                galleryPanel.classList.toggle('hidden');
                toggleIconWrapper.classList.toggle('rotate-180');
            });
        });
    </script>
</body>
</html>
